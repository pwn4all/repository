***
### EUC-KR 환경에서 만들어진 TXT 파일을 UTF-8 환경에서 누락 라인 없이 정리하는 방법
***
#### EUC-KR 환경에서 만들어진 CSV 형태의 TXT 파일 포맷(구분자:Tab)
```
COLUMN1 COLUMN2 COLUMN3
구분-1  키워드-1  문자열-1이 입력되어 있다.
구분-2  키워드-2  문자열-2이 입력되어 있다.
구분-3  키워드-3  문자열-3이 입력되어 있다.
구분-4  키워드-4  문자열-4이 입력되어 있다.
구분-5  키워드-5  "문자열-5이 입력되어 있다."
구분-6  키워드-6  "문자열-6이 입력되어 있다."
구분-7  키워드-7  "문자열-7이 입력되어 있다."
구분-8  키워드-8  "문자열-8이 입력되어 있다."
구분-9  키워드-9  "문자열-9이 입력되어 있다."
```
#### iconv 로 인코딩 변경이 정확함
```
$ iconv -c -f EUC-KR -t UTF-8 texts.txt > texts.csv
```


#### 엑셀과 CSV 모두 "문자열"를 할 셀로 판단하는 구분자에 영향을 주기 때문에 아래와 같이 문장에 있는 " 를 제거하고 축약하면 행이 꼬이는 문제가 없어질 수 있어서 먼저 제거해 봐야 한다.
***
```python
# 문장의 처음에 "가 있는 경우 pandas 로 셀을 나눌 때, csv 포맷이 꼬임 방지
df['text'] = df['text'].apply(lambda x: x.strip('"') if x.startswith('"') or x.endswith('"') else x)
# 'text' 열에서 "가 2개 이상 연속으로 있는 경우 " 하나로 변경
df['text'] = df['text'].str.replace(r'"+', '"', regex=True)
```


***
### 특이점1)
#### 메시지의 개수가 많을수록 TXT를 저장하는 코드에서 오류가 간혹 발행해서 줄의 마지막에 "\n" 이 생략되어 다음 줄이 연결되는 경우가 간혹 있다.
#### 이런 경우 csv 로 읽으면 가로(10)x세로(3)의 포맷이 깨지는 상황이 생긴다.
***
#### 해결방법
* vi texts.csv 를 하고 :set nu 를 한 다음 ctrl+d 로 스크롤롤 내리면 라인이 두 줄인 곳이 보이고
* 이 부분에 COLUMN3 과 다음 줄의 COLUMN1 이 연결된 부분이 보이고 여기서 수작업으로 줄바꿈 하면 된다.
* 오류로 이렇게 저장된 라인이 많지 않아서 수작업 처리가 간편하다.
* Before
```
구분-2  키워드-2  문자열-2이 입력되어 있다.구분-3  키워드-3  문자열-3이 입력되어 있다.구분-4  키워드-4  문자열-4이 입력되어 있다.
```

* After
```
구분-2  키워드-2  문자열-2이 입력되어 있다.
구분-3  키워드-3  문자열-3이 입력되어 있다.
구분-4  키워드-4  문자열-4이 입력되어 있다.
```

***
### 특이점2)
#### COLUMN3 이 " 로 시작하면서 엑셀이나 csv 에디터로 읽을 때 꼬여서 아래 예와 같이 여러 줄이 한 줄의 COLUMN3 에 포함되는 경우를 처리해야 한다.
***
```
$ vi texts.csv

# COLUMN2 다음 tab과 COLUMN3 이 " 로 시작하는 구성을 tab만 남도록 수정
:%s/\t"/\t/g
# COLUMN3 의 마지막에 있는 " 를 삭제해서 " 꼬임 상황 제거
:%s/"$//g
```
or
```python
##################################################################
## xlsx나 csv 를 읽을 때, 문장의 구분자에 영향을 주는 " 와 ' 를 제거
##################################################################
def rm_ambiguity_of_quote(df_, col_name):
    # 문장의 처음과 마지막에 있는 공백 제거
    df_[col_name] = df_[col_name].apply(lambda x: x.strip(' ') if x.startswith(' ') or x.endswith(' ') else x)
    # 문장의 처음에 "가 있는 경우 pandas 로 셀을 나눌 때, csv 포맷이 꼬임 방지
    df_[col_name] = df_[col_name].apply(lambda x: x.strip('"') if x.startswith('"') or x.endswith('"') else x)
    # 'text' 열에서 "가 2개 이상 연속으로 있는 경우 " 하나로 변경
    df_[col_name] = df_[col_name].str.replace(r'"+', '"', regex=True)
    df_[col_name] = df_[col_name].apply(lambda x: x.strip("'") if x.startswith("'") or x.endswith("'") else x)
    # 'text' 열에서 "가 2개 이상 연속으로 있는 경우 " 하나로 변경
    df_[col_name] = df_[col_name].str.replace(r"'+", "'", regex=True)
    # 'text' 열에서 \n 이 있는 경우 제거
    df_[col_name] = df_[col_name].str.replace(r'\n', ' ', regex=True)

    df_[~df_['text'].isnull()]

    return df_
```

#### 문제점 : pandas 로 읽는 과정에서 COLUMN3 에 있는 글자가 " 이 꼬이면 vi 로 읽었을 때는 10줄이지만 pandas/엑셀/Numbers/CSV 편집기로 열면 아래와 같이 줄이 꼬여서 5줄보다 적은 줄로 파일이 오픈되는 상황이 발생할 수 있다.
```
구분-1  키워드-1  문자열-1이 입력되어 있다.
구분-2  키워드-2  문자열-2이 입력되어 있다.구분-3  키워드-3  문자열-3이 입력되어 있다.구분-4  키워드-4  문자열-4이 입력되어 있다.
구분-5  키워드-5  "문자열-5이 입력되어 있다.구분-6  키워드-6  "문자열-6이 입력되어 있다."구분-7  키워드-7  "문자열-7이 입력되어 있다."구분-8  키워드-8  "문자열-8이 입력되어 있다.""
구분-9  키워드-4  "문자열-9이 입력되어 있다."
```

* " 이 꼬여서 여러 줄이 한 라인으로 잘못 읽히는 경우
* xlsx 타입으로 파일을 저장하고, Number 에서 보면 COLUMN3 하나의 셀에 "여러 라인"으로 묶인 것을 볼 수 있고, 묶인 라인만큼 추가해서 붙여넣기해도 된다.
* Before
```
구분-5  키워드-5  "문자열-5이 입력되어 있다.구분-6  키워드-6  "문자열-6이 입력되어 있다."구분-7  키워드-7  "문자열-7이 입력되어 있다."구분-8  키워드-8  "문자열-8이 입력되어 있다.""
```

* After
```
구분-5  키워드-5  "문자열-5이 입력되어 있다."
구분-6  키워드-6  "문자열-6이 입력되어 있다."
구분-7  키워드-7  "문자열-7이 입력되어 있다."
구분-8  키워드-8  "문자열-8이 입력되어 있다."
```


***
### 특이점3)
####  pd.read_csv() 함수로 읽어보면 아래와 같이 COLUMN3 에 포함된 tab 으로 인해 가로(10)x세로(3)의 포맷이 깨진 라인을 확인할 있고, 해당 라인을 찾아가서 문제의 tab 을 /\t 로 찾아가서 지운다.
***

```
Skipping line 34259: expected 3 fields, saw 4
Skipping line 34260: expected 3 fields, saw 4
Skipping line 43190: expected 3 fields, saw 4
```








